<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background: #f4f9ff; }
    h2 { color: #0073e6; }
    input, button, select {
      padding: 10px; margin: 10px; width: 80%; max-width: 300px;
      border-radius: 5px; border: 1px solid #ccc; font-size: 16px;
    }
    button { background: #0073e6; color: white; border: none; cursor: pointer; }
    button:hover { background: #005bb5; }
    #status { margin-top: 20px; font-weight: bold; }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; max-width: 700px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #0073e6; color: white; }
  </style>
</head>
<body>
  <h2>üìç Student Attendance</h2>
  <p>Please enter your details and allow location access.</p>

  <!-- Student Form -->
  <input type="text" id="name" placeholder="Enter Name" required><br>
  <input type="text" id="studentID" placeholder="Enter Student ID" required><br>
  <input type="text" id="cpr" placeholder="Enter CPR" required><br>
  <button onclick="markAttendance()">Mark Attendance</button>
  <p id="status"></p>

  <hr>

  <!-- Teacher Section -->
  <h3>üìä Teacher View</h3>
  <label for="monthSelect">Select Month:</label>
  <select id="monthSelect"></select>
  <button onclick="loadAttendance()">Load Records</button>
  <button onclick="exportCSV()">Export CSV</button>

  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Student ID</th>
        <th>CPR</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ‚úÖ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ‚úÖ Replace with your Firebase config
    const firebaseConfig = {
  apiKey: "AIzaSyDNYD4ePIvBsAwtED7XcubEnm_waowsBZU",
  authDomain: "student-attendance-54a24.firebaseapp.com",
  projectId: "student-attendance-54a24",
  storageBucket: "student-attendance-54a24.firebasestorage.app",
  messagingSenderId: "20815223762",
  appId: "1:20815223762:web:f5d8b79ee3d47b2739460b",
  measurementId: "G-DYPDLZYJ83"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const OFFICE_LAT = 26.2755686;
    const OFFICE_LON = 50.6376656;
    const RANGE_METERS = 150;

    function markAttendance() {
      const name = document.getElementById("name").value.trim();
      const studentID = document.getElementById("studentID").value.trim();
      const cpr = document.getElementById("cpr").value.trim();

      if (!name || !studentID || !cpr) {
        alert("Please fill all fields.");
        return;
      }

      if (!navigator.geolocation) {
        alert("Geolocation not supported in this browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const distance = getDistanceFromLatLon(lat, lon, OFFICE_LAT, OFFICE_LON);

          if (distance <= RANGE_METERS) {
            document.getElementById("status").innerHTML = "‚úÖ Attendance Marked Successfully!";
            saveAttendance(name, studentID, cpr, lat, lon);
          } else {
            document.getElementById("status").innerHTML =
              "‚ùå You are outside the office range (" + Math.round(distance) + " m away)";
          }
        },
        function () {
          document.getElementById("status").innerHTML = "‚ùå Location access denied.";
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function getDistanceFromLatLon(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ‚úÖ Save attendance in Firebase Firestore
    function saveAttendance(name, id, cpr, lat, lon) {
      const now = new Date();
      const month = now.toISOString().slice(0, 7); // YYYY-MM

      db.collection("attendance").add({
        name,
        studentID: id,
        cpr,
        lat,
        lon,
        timestamp: firebase.firestore.Timestamp.fromDate(now),
        month: month
      })
      .then(() => {
        document.getElementById("status").innerHTML = "‚úÖ Saved to Firebase!";
      })
      .catch((err) => {
        console.error(err);
        document.getElementById("status").innerHTML = "‚ùå Error saving attendance.";
      });
    }

    // ‚úÖ Teacher: populate month selector
    window.onload = function() {
      const select = document.getElementById("monthSelect");
      const now = new Date();
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const ym = d.toISOString().slice(0, 7);
        const option = document.createElement("option");
        option.value = ym;
        option.textContent = ym;
        select.appendChild(option);
      }
    };

    // ‚úÖ Teacher: load records for selected month
    function loadAttendance() {
      const month = document.getElementById("monthSelect").value;
      const tbody = document.getElementById("attendanceTable").querySelector("tbody");
      tbody.innerHTML = "";

      db.collection("attendance").where("month", "==", month).orderBy("timestamp", "asc").get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = `<tr>
            <td>${data.name}</td>
            <td>${data.studentID}</td>
            <td>${data.cpr}</td>
            <td>${data.lat}</td>
            <td>${data.lon}</td>
            <td>${data.timestamp.toDate().toLocaleString()}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });
    }

    // ‚úÖ Teacher: export records to CSV
    function exportCSV() {
      const rows = [];
      const table = document.getElementById("attendanceTable");
      for (let row of table.rows) {
        const cols = [];
        for (let cell of row.cells) {
          cols.push(`"${cell.innerText}"`);
        }
        rows.push(cols.join(","));
      }
      const csvContent = rows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "attendance.csv";
      link.click();
    }
  </script>
</body>
</html>
